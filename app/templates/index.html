<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wakeify - Wake up and smell the coffee</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.4;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Banner */
        .header-banner {
            background: #3b82f6;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alarm-icon {
            font-size: 24px;
        }
        
        .header-text h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .header-text p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .settings-icon {
            width: 20px;
            height: 20px;
            opacity: 0.8;
            cursor: pointer;
        }
        
        /* Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card.warning-card {
            background: #fff7ed;
            border-left: 4px solid #f97316;
            color: #7c2d12;
        }

        .warning-card h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .warning-card p {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .warning-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 6px;
        }

        .warning-card li {
            background: rgba(249, 115, 22, 0.15);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .warning-card li::before {
            content: "‚ö†Ô∏è";
            font-size: 14px;
        }

        .theme-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid #e5e5e7;
        }

        .theme-selector:last-child {
            border-bottom: none;
        }

        .theme-selector label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #86868b;
        }

        .theme-selector select {
            flex: 1;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #d1d1d6;
            background: #ffffff;
            color: #1d1d1f;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .theme-selector select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        
        /* Active Alarms Section */
        .alarms-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .alarms-title {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
        }
        
        .alarm-count {
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .no-alarms {
            text-align: center;
            color: #86868b;
            font-size: 16px;
            padding: 20px 0;
        }
        
        .alarm-item {
            background: #f5f5f7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e5e5e7;
        }
        
        .alarm-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .alarm-time {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
        }
        
        .alarm-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-play {
            background: #3b82f6;
            color: white;
        }
        
        .btn-play:hover {
            background: #2563eb;
        }
        
        .btn-stop {
            background: #ff3b30;
            color: white;
        }
        
        .btn-stop:hover {
            background: #d70015;
        }
        
        .btn-delete {
            background: #8e8e93;
            color: white;
        }
        
        .btn-delete:hover {
            background: #6d6d70;
        }
        
        .alarm-details {
            font-size: 14px;
            color: #86868b;
            line-height: 1.4;
        }
        
        .alarm-playlist {
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 4px;
        }
        
        .alarm-meta {
            font-size: 12px;
        }
        
        /* Form Styles */
        .form-title {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .form-row .form-select {
            flex: 1;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            transition: border-color 0.2s;
        }
        
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .time-inputs {
            display: flex;
            gap: 8px;
        }
        
        .time-inputs .form-select {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
        }
        
        .checkbox-group label {
            font-size: 14px;
            color: #1d1d1f;
            cursor: pointer;
        }
        
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
        }
        
        .day-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .day-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #3b82f6;
        }
        
        .day-label {
            font-size: 12px;
            color: #1d1d1f;
            cursor: pointer;
            text-align: center;
        }
        
        .volume-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .volume-label {
            font-size: 14px;
            color: #1d1d1f;
            min-width: 80px;
        }
        
        .volume-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e5e5e7;
            outline: none;
            appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
        }
        
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }
        
        .submit-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        /* Status Panel Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.2s;
        }
        
        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            margin-left: -8px;
            margin-right: -8px;
            padding-left: 8px;
            padding-right: 8px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            color: #86868b;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: #1d1d1f;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }
        
        .status-label {
            font-size: 14px;
            color: #86868b;
        }
        
        .status-value {
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.connected {
            background: #34d399;
            color: white;
        }
        
        .status-badge.disconnected {
            background: #fca5a5;
            color: white;
        }
        
        .status-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e5e5e7;
        }
        
        .status-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .icon-btn {
            padding: 8px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background: transparent;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            overflow: visible;
        }
        
        .icon-btn svg {
            width: 18px;
            height: 18px;
            fill: #1d1d1f;
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            background: #f5f5f5;
        }
        
        .icon-btn:hover svg {
            fill: #3b82f6;
        }
        
        .icon-btn:active {
            transform: scale(0.95);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .container {
                max-width: 600px;
            }
        }
  </style>
</head>
<body>
    <div class="container">
        <!-- Header Banner -->
        <div class="header-banner">
            <div class="header-left">
                <div class="alarm-icon">‚è∞</div>
                <div class="header-text">
                    <h1>Wakeify</h1>
                    <p>Wake up and smell the coffee ‚òï</p>
        </div>
            </div>
            <svg class="settings-icon" onclick="toggleStatusPanel()" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
            </svg>
        </div>

        <!-- Health Check Alert Banner -->
        <div class="card warning-card" id="healthCheckAlert" style="display: none; background: #fef3c7; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0 0 4px 0; color: #92400e;">‚ö†Ô∏è Health Check Alert</h3>
                    <p style="margin: 0; color: #78350f; font-size: 14px;">Issues detected in last health check. Check System Status for details.</p>
                </div>
                <button onclick="document.getElementById('healthCheckAlert').style.display='none'" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #78350f;">‚úï</button>
            </div>
        </div>

        {% if manual_auth_devices %}
        <div class="card warning-card">
            <h2>Manual Spotify Activation Needed</h2>
            <p>Select each device below in the Spotify app and play a track once to finish linking it.</p>
            <ul>
                {% for device in manual_auth_devices %}
                <li>{{ device }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        <!-- Active Alarms Section -->
            <div class="card">
            <div class="alarms-header">
                <h2 class="alarms-title">Active Alarms</h2>
                <div class="alarm-count">{{ alarms|length }}</div>
            </div>
            
            {% if alarms %}
                {% for alarm in alarms %}
                <div class="alarm-item">
                    <div class="alarm-header">
                        <div class="alarm-time">
                            {% set hour = alarm.hour|int %}
                            {% set minute = "%02d" | format(alarm.minute|int) %}
                            {% if hour == 0 %}
                                12:{{ minute }} AM
                            {% elif hour < 12 %}
                                {{ hour }}:{{ minute }} AM
                            {% elif hour == 12 %}
                                12:{{ minute }} PM
                            {% else %}
                                {{ hour - 12 }}:{{ minute }} PM
                            {% endif %}
                            {% if alarm.stop_hour is defined and alarm.stop_minute is defined %}
                                {% set stop_hour = alarm.stop_hour|int %}
                                {% set stop_minute = "%02d" | format(alarm.stop_minute|int) %}
                                -
                                {% if stop_hour == 0 %}
                                    12:{{ stop_minute }} AM
                                {% elif stop_hour < 12 %}
                                    {{ stop_hour }}:{{ stop_minute }} AM
                                {% elif stop_hour == 12 %}
                                    12:{{ stop_minute }} PM
                                {% else %}
                                    {{ stop_hour - 12 }}:{{ stop_minute }} PM
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="alarm-actions">
                            <button class="btn btn-play" onclick="playNow('{{ alarm.id }}')">Play Now</button>
                            <button class="btn btn-stop" onclick="stopPlayback('{{ alarm.id }}')">Stop</button>
                            <button class="btn btn-delete" onclick="deleteAlarm('{{ alarm.id }}')">Delete</button>
                        </div>
                    </div>
                    <div class="alarm-details">
                        <div class="alarm-playlist">{{ alarm.playlist_name }}</div>
                        <div class="alarm-meta">
                            {% set dow_list = alarm.dow.split(',') %}
                            {% for day in dow_list %}
                                {{ day|title }}
                                {% if not loop.last %}, {% endif %}
                            {% endfor %}
                            ‚Ä¢ {{ alarm.device_name }} ‚Ä¢ Vol {{ alarm.volume }}%{% if alarm.shuffle %} ‚Ä¢ Shuffle ON{% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-alarms">No active alarms</div>
            {% endif %}
        </div>
        
        <!-- Spotify Connection Screen -->
        {% if not spotify_connected %}
        <div class="card">
            <div style="text-align: center; padding: 40px 20px;">
                <!-- Success Message - only show if actually connected (not in disconnected state) -->
                <!-- Note: This block only shows when disconnected, so success message should not appear here -->
                
                <!-- Error Message -->
                {% if auth_error %}
                <div style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                    ‚ùå Connection failed: {{ auth_error }}
            </div>
                {% endif %}
                
                <div style="font-size: 48px; margin-bottom: 20px;">üéµ</div>
                <h2 style="color: #1d1d1f; margin-bottom: 12px;">Connect to Spotify</h2>
                <p style="color: #86868b; margin-bottom: 30px; line-height: 1.5;">
                    To set up alarms, you need to connect your Spotify account.<br>
                    This allows the app to access your playlists and control playback.
                </p>
                <a href="{{ spotify_auth_url }}" style="display: inline-block; background: #1db954; color: white; padding: 16px 32px; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 16px;">
                    Connect Spotify Account
                </a>
                <p style="color: #86868b; font-size: 12px; margin-top: 20px;">
                    You'll be redirected to Spotify to authorize the app
                </p>
            </div>
        </div>
        {% else %}
        <!-- Success Message when connected -->
        {% if auth_success %}
        <div class="card" style="background: #d4edda; border: 1px solid #c3e6cb;">
            <div style="text-align: center; padding: 12px; color: #155724;">
                ‚úÖ Successfully connected to Spotify!
            </div>
        </div>
        {% endif %}
        
        <!-- Set New Alarm Form -->
            <div class="card">
            <h2 class="form-title">Set New Alarm</h2>
            
                <form method="post" action="/set_alarm">
                <!-- Playlist -->
                        <div class="form-group">
                    <label class="form-label">Playlist</label>
                    <div class="form-row">
                        <select class="form-select" name="playlist_uri" id="playlist_uri" required>
                                {% if playlists %}
                                    <option value="">Select a playlist...</option>
                                    {% for playlist in playlists %}
                                    <option value="{{ playlist.uri }}">{{ playlist.name }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="">No playlists available - Connect to Spotify first</option>
                                {% endif %}
                            </select>
                        <div class="checkbox-group">
                            <input type="checkbox" name="shuffle" id="shuffle"{% if default_shuffle %} checked{% endif %}>
                            <label for="shuffle">Shuffle</label>
                        </div>
                    </div>
                        </div>
                        
                <!-- Device -->
                        <div class="form-group">
                    <label class="form-label">Device</label>
                    <select class="form-select" name="device_name" id="device_name" required>
                                {% if devices %}
                                    {% for device in devices %}
                                    <option value="{{ device.name }}"{% if device.name == default_speaker %} selected{% endif %}>
                                        {{ device.name }}
                                    </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="">No devices available - Discover devices first</option>
                                {% endif %}
                            </select>
                    </div>
                    
                <!-- Start Time -->
                        <div class="form-group">
                    <label class="form-label">Start Time</label>
                    <div class="time-inputs">
                        <select class="form-select" name="hour" id="hour" required>
                                    {% for hour in range(1, 13) %}
                                        <option value="{{ hour }}"{% if hour == 7 %} selected{% endif %}>{{ hour }}</option>
                                    {% endfor %}
                                </select>
                        <select class="form-select" name="minute" id="minute" required>
                                {% for minute in range(60) %}
                                <option value="{{ minute }}"{% if minute == 0 %} selected{% endif %}>{{ "%02d"|format(minute) }}</option>
                                {% endfor %}
                            </select>
                        <select class="form-select" name="hour_period" id="hour_period" required>
                            <option value="AM" selected>AM</option>
                            <option value="PM">PM</option>
                        </select>
                        </div>
                    </div>
                    
                <!-- Stop Time -->
                        <div class="form-group">
                    <label class="form-label">Stop Time (Optional)</label>
                    <div class="time-inputs">
                        <select class="form-select" name="stop_hour" id="stop_hour">
                            <option value="">N/A</option>
                                    {% for hour in range(1, 13) %}
                                        <option value="{{ hour }}">{{ hour }}</option>
                                    {% endfor %}
                                </select>
                        <select class="form-select" name="stop_minute" id="stop_minute">
                            <option value="">N/A</option>
                                {% for minute in range(60) %}
                                <option value="{{ minute }}">{{ "%02d"|format(minute) }}</option>
                                {% endfor %}
                            </select>
                        <select class="form-select" name="stop_hour_period" id="stop_hour_period">
                            <option value="">N/A</option>
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                        </select>
                        </div>
                    </div>
                    
                <!-- Days of Week -->
                    <div class="form-group">
                    <label class="form-label">Days of Week</label>
                    <div class="days-grid">
                        <div class="day-checkbox">
                                <input type="checkbox" name="dow" value="mon" id="mon" checked>
                            <label class="day-label" for="mon">Mon</label>
                            </div>
                        <div class="day-checkbox">
                                <input type="checkbox" name="dow" value="tue" id="tue" checked>
                            <label class="day-label" for="tue">Tue</label>
                            </div>
                        <div class="day-checkbox">
                                <input type="checkbox" name="dow" value="wed" id="wed" checked>
                            <label class="day-label" for="wed">Wed</label>
                            </div>
                        <div class="day-checkbox">
                                <input type="checkbox" name="dow" value="thu" id="thu" checked>
                            <label class="day-label" for="thu">Thu</label>
                            </div>
                        <div class="day-checkbox">
                                <input type="checkbox" name="dow" value="fri" id="fri" checked>
                            <label class="day-label" for="fri">Fri</label>
                            </div>
                        <div class="day-checkbox">
                                <input type="checkbox" name="dow" value="sat" id="sat">
                            <label class="day-label" for="sat">Sat</label>
                            </div>
                        <div class="day-checkbox">
                                <input type="checkbox" name="dow" value="sun" id="sun">
                            <label class="day-label" for="sun">Sun</label>
                            </div>
                        </div>
                    </div>
                    
                <!-- Volume -->
                <div class="form-group">
                    <div class="volume-group">
                        <label class="volume-label">Volume: <span id="volume-display">{{ default_volume }}</span>%</label>
                        <input type="range" name="volume" id="volume" min="0" max="100" value="{{ default_volume }}" class="volume-slider">
                    </div>
            </div>
            
                <!-- Submit Button -->
                <button type="submit" class="submit-btn">Set Alarm</button>
                                </form>
                </div>
                {% endif %}
    </div>
    
    <script>
        // Volume slider
        const volumeSlider = document.getElementById('volume');
        const volumeDisplay = document.getElementById('volume-display');
        
        if (volumeSlider && volumeDisplay) {
            volumeSlider.addEventListener('input', function() {
                volumeDisplay.textContent = this.value;
            });
        }
        
        // System status panel
        function toggleStatusPanel() {
            const modal = document.getElementById('statusModal');
            modal.classList.add('active');
            loadHealthCheckStatusForSystemStatus();
        }
        
        async function loadHealthCheckStatusForSystemStatus() {
            try {
                const response = await fetch('/api/settings/health-check');
                const settings = await response.json();
                
                const displayDiv = document.getElementById('healthCheckStatusDisplay');
                if (!displayDiv) return;
                
                if (settings.last_status) {
                    const statusClass = settings.last_status === 'healthy' ? 'connected' : 'disconnected';
                    const statusText = settings.last_status.charAt(0).toUpperCase() + settings.last_status.slice(1);
                    
                    let html = `<div style="display: flex; align-items: center; gap: 8px;">`;
                    html += `<span class="status-badge ${statusClass}">${statusText}</span>`;
                    
                    if (settings.last_check) {
                        const date = new Date(settings.last_check * 1000);
                        html += `<span style="color: #86868b; font-size: 12px;">${date.toLocaleString()}</span>`;
                    }
                    
                    html += `</div>`;
                    displayDiv.innerHTML = html;
                } else {
                    displayDiv.innerHTML = '<div style="color: #86868b;">No health checks run yet</div>';
                }
            } catch (error) {
                console.error('Failed to load health check status:', error);
                const displayDiv = document.getElementById('healthCheckStatusDisplay');
                if (displayDiv) {
                    displayDiv.innerHTML = '<div style="color: #86868b;">Error loading status</div>';
                }
            }
        }
        
        // Play alarm now
        async function playNow(alarmId) {
            try {
                const response = await fetch(`/play_alarm_now/${alarmId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Playback started!');
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to start playback');
                }
            } catch (error) {
                console.error('Error starting playback:', error);
                alert('Failed to start playback');
            }
        }
        
        // Delete alarm
        async function deleteAlarm(alarmId) {
            try {
                const response = await fetch(`/delete_alarm/${alarmId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete alarm');
                }
            } catch (error) {
                console.error('Error deleting alarm:', error);
                alert('Failed to delete alarm');
            }
        }
        
        // Stop playback
        async function stopPlayback(alarmId) {
            try {
                const response = await fetch('/stop_current_playback', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Playback stopped');
                } else {
                    alert('Failed to stop playback');
                }
            } catch (error) {
                console.error('Error stopping playback:', error);
                alert('Failed to stop playback');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const uiThemeSelector = document.getElementById('ui-theme-selector');
            if (uiThemeSelector) {
                uiThemeSelector.addEventListener('change', (event) => {
                    const view = event.target.value;
                    const target = view === 'aurora' ? '/aurora' : '/';
                    window.location.href = target;
                });
            }
            
            // Load health check alert banner on page load
            loadHealthCheckAlert();
        });
        
        async function loadHealthCheckAlert() {
            try {
                const response = await fetch('/api/settings/health-check');
                const settings = await response.json();
                
                const alertBanner = document.getElementById('healthCheckAlert');
                if (!alertBanner) return;
                
                // Show alert if there are issues (status is not healthy)
                if (settings.last_status && settings.last_status !== 'healthy') {
                    alertBanner.style.display = 'block';
                } else {
                    alertBanner.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load health check alert:', error);
                // Hide alert on error
                const alertBanner = document.getElementById('healthCheckAlert');
                if (alertBanner) {
                    alertBanner.style.display = 'none';
                }
            }
        }
    </script>
    
    <!-- Status Panel Modal -->
    <div id="statusModal" class="modal-overlay" onclick="closeStatusPanel(event)">
        <div class="modal-content status-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">System Status</h2>
                <button class="modal-close" onclick="closeStatusPanel()">‚úï</button>
            </div>
            
        <div class="theme-selector">
            <label for="ui-theme-selector">UI Theme</label>
            <select id="ui-theme-selector">
                <option value="basic" {% if active_view == 'classic' %}selected{% endif %}>Basic</option>
                <option value="aurora" {% if active_view == 'aurora' %}selected{% endif %} disabled>Aurora (Coming Soon)</option>
            </select>
        </div>
            
            <!-- Connection Status -->
            <div class="status-section">
                <div class="status-item">
                    <span class="status-label">üéµ Spotify</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-badge {{ 'connected' if spotify_connected else 'disconnected' }}">
                            {{ 'Connected' if spotify_connected else 'Disconnected' }}
                        </span>
                        {% if spotify_connected %}
                        <button class="icon-btn" onclick="disconnectSpotify()" title="Disconnect">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path fill="none" stroke="#1d1d1f" stroke-width="2" stroke-linecap="round" d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Health Check Status -->
            <div class="status-section">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 13px; color: #86868b; font-weight: 500;">üè• Health Check</span>
                    <button class="icon-btn" onclick="openHealthCheckSettings()" title="Settings">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px;">
                            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                        </svg>
                    </button>
                </div>
                <div id="healthCheckStatusDisplay" style="font-size: 13px;">
                    <div style="color: #86868b;">Loading...</div>
                </div>
            </div>
            
            <!-- Speakers Info -->
            <div class="status-section">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 13px; color: #86868b;">üîä Speakers ({{ devices|length }})</span>
                    <button class="icon-btn" onclick="refreshSpeakers()" title="Refresh">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    </button>
                </div>
                <div id="speakersList" style="max-height: 150px; overflow-y: auto;">
                    {% for device in devices %}
                    <div style="padding: 6px 0; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                        {% if device.is_online %}
                        <svg style="width: 16px; height: 16px; fill: #10b981;" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10"/></svg>
                        {% else %}
                        <svg style="width: 16px; height: 16px; fill: #6b7280;" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill-opacity="0.3" stroke="#6b7280" stroke-width="1"/></svg>
                        {% endif %}
                        <span style="font-weight: 500; flex: 1;">{{ device.name }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Alarms Info -->
            <div class="status-section">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 13px; color: #86868b;">‚è∞ Alarms: <strong>{{ alarms|length }}</strong></span>
                    {% if alarms|length > 0 %}
                    <button class="icon-btn" onclick="clearAllAlarms()" title="Clear all">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Health Check Settings Modal -->
    <div id="healthCheckSettingsModal" class="modal-overlay" onclick="closeHealthCheckSettings(event)" style="display: none;">
        <div class="modal-content status-modal" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Health Check Settings</h2>
                <button class="modal-close" onclick="closeHealthCheckSettings()">‚úï</button>
            </div>
            
            <div style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <input type="checkbox" id="healthCheckEnabled" onchange="updateHealthCheckUI()">
                        <span style="font-weight: 600;">Enable Health Checks</span>
                    </label>
                    <p style="font-size: 13px; color: #86868b; margin: 4px 0 0 24px;">
                        Automatically check Spotify connection and device availability
                    </p>
                </div>
                
                <div id="healthCheckSettings" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Check Interval (days)</label>
                        <input type="number" id="healthCheckInterval" min="1" value="3" style="width: 100%; padding: 8px; border: 1px solid #d1d1d6; border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Check Time (HH:MM)</label>
                        <input type="time" id="healthCheckTime" value="09:00" style="width: 100%; padding: 8px; border: 1px solid #d1d1d6; border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 12px; background: #f5f5f7; border-radius: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="emailEnabled" onchange="updateEmailUI()">
                            <span style="font-weight: 600;">Enable Email Notifications</span>
                        </label>
                        <div id="emailSettings" style="display: none; margin-top: 12px; margin-left: 24px;">
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Email Recipient</label>
                                <input type="email" id="emailRecipient" placeholder="your@email.com" style="width: 100%; padding: 8px; border: 1px solid #d1d1d6; border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Gmail App Password</label>
                                <input type="text" id="gmailPassword" placeholder="" style="width: 100%; padding: 8px; border: 1px solid #d1d1d6; border-radius: 6px; font-family: monospace;" onfocus="if(this.value === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' || this.getAttribute('data-has-password') === 'true') { this.value = ''; this.removeAttribute('data-has-password'); }">
                                <p style="font-size: 12px; color: #86868b; margin-top: 4px;">
                                    Get app password from <a href="https://myaccount.google.com/apppasswords" target="_blank" style="color: #3b82f6;">Google Account Settings</a>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 13px;">
                        <div style="margin-bottom: 8px;"><strong>Last Check:</strong> <span id="lastCheckDisplay">Never</span></div>
                        <div><strong>Status:</strong> <span id="lastStatusDisplay">-</span></div>
                        <div style="margin-top: 8px;"><strong>Next Check:</strong> <span id="nextCheckDisplay">-</span></div>
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button onclick="testHealthCheck()" style="flex: 1; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            Test Now
                        </button>
                        <button onclick="saveHealthCheckSettings()" style="flex: 1; padding: 10px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function closeStatusPanel(event) {
            const modal = document.getElementById('statusModal');
            if (event && modal.contains(event.target)) {
                return;
            }
            modal.classList.remove('active');
        }
        
        async function refreshSpeakers() {
            try {
                const response = await fetch('/api/devices/refresh', {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Failed to refresh speakers: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to refresh speakers: ' + error.message);
            }
        }
        
        async function clearAllAlarms() {
            if (!confirm('Are you sure you want to delete all alarms?')) {
                return;
            }
            try {
                const alarms = {{ alarms|tojson }};
                const promises = alarms.map(alarm => 
                    fetch(`/delete_alarm/${alarm.id}`, { method: 'DELETE' })
                );
                await Promise.all(promises);
                location.reload();
            } catch (error) {
                alert('Failed to clear alarms');
            }
        }
        
        async function disconnectSpotify() {
            if (!confirm('Are you sure you want to disconnect from Spotify?')) {
                return;
            }
            // Delete the token file
            try {
                await fetch('/api/disconnect', { method: 'POST' });
                location.reload();
            } catch (error) {
                alert('Failed to disconnect Spotify');
            }
        }
        
        // Health Check Settings Functions
        function openHealthCheckSettings() {
            loadHealthCheckSettings();
            document.getElementById('healthCheckSettingsModal').style.display = 'flex';
        }
        
        function closeHealthCheckSettings(event) {
            const modal = document.getElementById('healthCheckSettingsModal');
            // If clicking inside modal-content, don't close (let stopPropagation handle it)
            if (event && event.target.closest('.modal-content')) {
                return;
            }
            // Close modal when clicking overlay or when called directly (e.g., X button)
            modal.style.display = 'none';
        }
        
        async function loadHealthCheckSettings() {
            try {
                const response = await fetch('/api/settings/health-check');
                const settings = await response.json();
                
                document.getElementById('healthCheckEnabled').checked = settings.enabled || false;
                document.getElementById('healthCheckInterval').value = settings.interval_days || 3;
                document.getElementById('healthCheckTime').value = settings.time || '09:00';
                document.getElementById('emailEnabled').checked = settings.email?.enabled || false;
                document.getElementById('emailRecipient').value = settings.email?.recipient || '';
                
                // Show masked password if one exists (for display only)
                const passwordField = document.getElementById('gmailPassword');
                if (settings.email?.has_password) {
                    passwordField.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; // 16 dots to match Gmail app password length
                    passwordField.setAttribute('data-has-password', 'true');
                } else {
                    passwordField.value = '';
                    passwordField.removeAttribute('data-has-password');
                }
                
                if (settings.last_check) {
                    const date = new Date(settings.last_check * 1000);
                    document.getElementById('lastCheckDisplay').textContent = date.toLocaleString();
                } else {
                    document.getElementById('lastCheckDisplay').textContent = 'Never';
                }
                
                document.getElementById('lastStatusDisplay').textContent = settings.last_status ? settings.last_status.charAt(0).toUpperCase() + settings.last_status.slice(1) : '-';
                
                if (settings.next_check) {
                    const date = new Date(settings.next_check * 1000);
                    document.getElementById('nextCheckDisplay').textContent = date.toLocaleString();
                } else {
                    document.getElementById('nextCheckDisplay').textContent = '-';
                }
                
                updateHealthCheckUI();
                updateEmailUI();
            } catch (error) {
                console.error('Failed to load health check settings:', error);
                alert('Failed to load settings');
            }
        }
        
        function updateHealthCheckUI() {
            const enabled = document.getElementById('healthCheckEnabled').checked;
            document.getElementById('healthCheckSettings').style.display = enabled ? 'block' : 'none';
        }
        
        function updateEmailUI() {
            const enabled = document.getElementById('emailEnabled').checked;
            document.getElementById('emailSettings').style.display = enabled ? 'block' : 'none';
        }
        
        async function saveHealthCheckSettings() {
            try {
                const passwordField = document.getElementById('gmailPassword');
                // Only send password if user entered a new one (not the masked placeholder)
                const passwordValue = passwordField.value;
                const isMaskedPassword = passwordField.getAttribute('data-has-password') === 'true' && passwordValue === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                
                const settings = {
                    enabled: document.getElementById('healthCheckEnabled').checked,
                    interval_days: parseInt(document.getElementById('healthCheckInterval').value) || 3,
                    time: document.getElementById('healthCheckTime').value || '09:00',
                    email: {
                        enabled: document.getElementById('emailEnabled').checked,
                        recipient: document.getElementById('emailRecipient').value.trim(),
                        gmail_app_password: isMaskedPassword ? '' : passwordValue.trim() // Don't send masked placeholder
                    }
                };
                
                const response = await fetch('/api/settings/health-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    alert('Failed to save: ' + (errorData.detail || 'Unknown error'));
                    return;
                }
                
                alert('Settings saved successfully!');
                document.getElementById('gmailPassword').value = '';
                loadHealthCheckSettings();
                loadHealthCheckAlert(); // Update alert banner after settings change
            } catch (error) {
                alert('Error: ' + error.message);
                console.error('Save error:', error);
            }
        }
        
        async function testHealthCheck() {
            const button = event.target;
            try {
                button.disabled = true;
                button.textContent = 'Running...';
                
                const response = await fetch('/api/settings/health-check/test', {
                    method: 'POST'
                });
                
                // Check if response is OK
                if (!response.ok) {
                    // Try to get error message from response
                    let errorMessage = 'Unknown error';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.error || errorData.message || `HTTP ${response.status}`;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    alert('Health check failed: ' + errorMessage);
                    button.disabled = false;
                    button.textContent = 'Test Now';
                    return;
                }
                
                const result = await response.json();
                if (result.status === 'success') {
                    const status = result.results?.overall_status || 'unknown';
                    const issueCount = result.results?.issues?.length || 0;
                    let message = 'Health check completed! Status: ' + status;
                    if (issueCount > 0) {
                        message += `\n\nFound ${issueCount} issue(s):\n${result.results.issues.slice(0, 3).join('\n')}`;
                        if (issueCount > 3) {
                            message += `\n... and ${issueCount - 3} more`;
                        }
                    }
                    alert(message);
                    loadHealthCheckSettings(); // Reload to show updated status
                    loadHealthCheckAlert(); // Update alert banner
                    loadHealthCheckStatusForSystemStatus(); // Update system status display
                } else {
                    alert('Health check failed: ' + (result.error || result.detail || 'Unknown error'));
                }
                
                button.disabled = false;
                button.textContent = 'Test Now';
            } catch (error) {
                console.error('Failed to run health check:', error);
                alert('Failed to run health check: ' + (error.message || 'Network error'));
                button.disabled = false;
                button.textContent = 'Test Now';
            }
        }
    </script>
</body>
</html>